<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D Temporal Map - Eno Worldbuilding</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Event Modal CSS -->
    <link rel="stylesheet" href="../css/event-modal.css" />

    <!-- Epoch Overlay CSS -->
    <link rel="stylesheet" href="../css/epoch-overlays.css" />

    <!-- Temporal Heat Map CSS -->
    <link rel="stylesheet" href="../css/temporal-heatmap.css" />

    <!-- Character Journey CSS -->
    <link rel="stylesheet" href="../css/character-journeys.css" />

    <!-- Territory Animation CSS -->
    <link rel="stylesheet" href="../css/territory-animations.css" />

    <!-- Historical Snapshot CSS -->
    <link rel="stylesheet" href="../css/historical-snapshots.css" />

    <!-- Temporal Data Export CSS -->
    <link rel="stylesheet" href="../css/temporal-data-export.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .page-header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            pointer-events: none;
        }

        .page-header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .page-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        #mapContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Temporal Controls Styling */
        .temporal-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .temporal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 2px solid #e0e0e0;
            background: rgba(52, 73, 94, 0.1);
        }

        .temporal-header h3 {
            color: #2c3e50;
            font-size: 1.2em;
            margin: 0;
        }

        .toggle-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .temporal-body {
            padding: 20px;
            display: block;
        }

        .time-display-large {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-time {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .current-era {
            font-size: 1em;
            color: #7f8c8d;
            font-style: italic;
        }

        .playback-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: #3498db;
            color: white;
            font-size: 18px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .speed-control {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .speed-control label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #2c3e50;
        }

        .speed-control select {
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            min-width: 120px;
        }

        .timeline-scrubber {
            position: relative;
            margin-bottom: 15px;
        }

        .scrubber-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 5px;
            padding: 0 10px;
        }

        #timeScrubber {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        #timeScrubber::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        #timeScrubber::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.2);
        }

        #timeScrubber::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: grab;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .scrubber-marker {
            position: absolute;
            top: -2px;
            width: 2px;
            height: 12px;
            background: #e74c3c;
            pointer-events: none;
            border-radius: 1px;
        }

        .temporal-filters {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .temporal-filters label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #2c3e50;
            cursor: pointer;
        }

        .temporal-filters input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #3498db;
        }

        .quick-jumps {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .quick-jump-btn {
            padding: 8px 12px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #2c3e50;
            transition: all 0.3s;
        }

        .quick-jump-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        /* Temporal Event Marker Styling */
        .temporal-event-marker {
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .temporal-event-marker:hover {
            transform: scale(1.2);
            z-index: 1000;
        }

        /* Temporal Event Popup Styling */
        .temporal-event-popup {
            max-width: 250px;
        }

        .temporal-event-popup h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 4px;
        }

        .event-time {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 4px;
        }

        .event-type {
            background: #ecf0f1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #7f8c8d;
            display: inline-block;
            margin-bottom: 8px;
        }

        .event-participants {
            font-size: 12px;
            color: #34495e;
            margin-top: 8px;
        }

        .event-importance {
            font-size: 12px;
            color: #f39c12;
            margin-top: 4px;
        }

        /* Map Controls Positioning */
        .leaflet-top.leaflet-right {
            top: 70px; /* Make room for header */
        }

        .leaflet-bottom.leaflet-left {
            bottom: 320px; /* Make room for temporal controls */
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.4em;
            }

            .temporal-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-height: 250px;
            }

            .temporal-body {
                padding: 15px;
            }

            .playback-controls {
                gap: 10px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .speed-control {
                gap: 15px;
            }

            .quick-jumps {
                gap: 8px;
            }

            .quick-jump-btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .leaflet-bottom.leaflet-left {
                bottom: 270px;
            }
        }

        @media (max-width: 480px) {
            .temporal-controls {
                max-height: 200px;
            }

            .speed-control {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .temporal-filters {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .leaflet-bottom.leaflet-left {
                bottom: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>üåç‚è∞ 4D Temporal Map</h1>
        <p>Explore space and time across 12,000+ cycles of world history</p>
    </div>

    <div id="mapContainer">
        <div id="map"></div>

        <!-- Epoch Controls Panel -->
        <div class="epoch-controls" id="epochControls">
            <h3>üé® Era Visualizations</h3>

            <div class="epoch-toggle">
                <input type="checkbox" id="epochOverlaysEnabled" checked>
                <label for="epochOverlaysEnabled">Epoch Atmosphere</label>
            </div>

            <div class="epoch-toggle">
                <input type="checkbox" id="eraLabelsEnabled" checked>
                <label for="eraLabelsEnabled">Era Labels</label>
            </div>

            <div class="epoch-toggle">
                <input type="checkbox" id="epochBoundariesEnabled">
                <label for="epochBoundariesEnabled">Era Boundaries</label>
            </div>

            <div class="intensity-slider">
                <label for="epochIntensity">Atmosphere Intensity</label>
                <input type="range" id="epochIntensity" min="0" max="1" step="0.1" value="0.6">
                <div class="intensity-value" id="intensityValue">60%</div>
            </div>

            <div class="epoch-toggle">
                <input type="checkbox" id="epochTransitionsEnabled" checked>
                <label for="epochTransitionsEnabled">Smooth Transitions</label>
            </div>
        </div>

        <!-- Character Journey Controls Panel -->
        <div class="journey-controls" id="journeyControls">
            <h3>üó∫Ô∏è Character Journeys</h3>

            <div class="journey-section">
                <h4>Visualization Options</h4>

                <div class="journey-toggle">
                    <input type="checkbox" id="journeysEnabled" checked>
                    <label for="journeysEnabled">Show Journey Paths</label>
                </div>

                <div class="journey-toggle">
                    <input type="checkbox" id="relationshipsEnabled" checked>
                    <label for="relationshipsEnabled">Show Relationships</label>
                </div>

                <div class="journey-toggle">
                    <input type="checkbox" id="lifeEventsEnabled" checked>
                    <label for="lifeEventsEnabled">Show Life Events</label>
                </div>

                <div class="journey-toggle">
                    <input type="checkbox" id="influenceZonesEnabled">
                    <label for="influenceZonesEnabled">Show Influence Zones</label>
                </div>
            </div>

            <div class="journey-section">
                <h4>Character Selection</h4>

                <div class="character-list-controls">
                    <button class="character-list-btn" id="selectAllCharacters">Select All</button>
                    <button class="character-list-btn" id="deselectAllCharacters">Deselect All</button>
                </div>

                <div class="character-list" id="characterList">
                    <div class="journey-loading">Loading characters...</div>
                </div>
            </div>

            <div class="journey-section">
                <h4>Display Settings</h4>

                <div class="path-opacity-control">
                    <label for="pathOpacity">Path Opacity</label>
                    <input type="range" id="pathOpacity" class="path-opacity-slider" min="0" max="1" step="0.1" value="0.7">
                    <div class="slider-value" id="pathOpacityValue">70%</div>
                </div>

                <div class="time-window-control">
                    <label for="timeWindow">Time Window (cycles)</label>
                    <input type="range" id="timeWindow" class="time-window-slider" min="10" max="500" step="10" value="100">
                    <div class="slider-value" id="timeWindowValue">100 cycles</div>
                </div>
            </div>

            <div class="journey-section">
                <h4>Animation</h4>

                <div class="animation-controls">
                    <button class="animation-btn" id="playJourneyAnimation">Play Journey</button>
                    <button class="animation-btn" id="stopJourneyAnimation">Stop</button>
                </div>
            </div>

            <div class="journey-stats" id="journeyStats">
                <h4>Statistics</h4>
                <div class="stat-row">
                    <span>Total Characters:</span>
                    <span class="stat-value" id="totalCharacters">0</span>
                </div>
                <div class="stat-row">
                    <span>Selected:</span>
                    <span class="stat-value" id="selectedCharacters">0</span>
                </div>
                <div class="stat-row">
                    <span>Life Events:</span>
                    <span class="stat-value" id="totalEvents">0</span>
                </div>
                <div class="stat-row">
                    <span>Relationships:</span>
                    <span class="stat-value" id="totalRelationships">0</span>
                </div>
            </div>
        </div>

        <!-- Territory Animation Controls Panel -->
        <div class="territory-controls" id="territoryControls">
            <h3>üèõÔ∏è Territory Evolution</h3>

            <div class="territory-section">
                <h4>Visualization Options</h4>

                <div class="territory-toggle">
                    <input type="checkbox" id="territoriesEnabled" checked>
                    <label for="territoriesEnabled">Show Territories</label>
                </div>

                <div class="territory-toggle">
                    <input type="checkbox" id="bordersEnabled" checked>
                    <label for="bordersEnabled">Show Borders</label>
                </div>

                <div class="territory-toggle">
                    <input type="checkbox" id="conflictZonesEnabled" checked>
                    <label for="conflictZonesEnabled">Show Conflict Zones</label>
                </div>

                <div class="territory-toggle">
                    <input type="checkbox" id="tradeRoutesEnabled">
                    <label for="tradeRoutesEnabled">Show Trade Routes</label>
                </div>

                <div class="territory-toggle">
                    <input type="checkbox" id="smoothTransitionsEnabled" checked>
                    <label for="smoothTransitionsEnabled">Smooth Transitions</label>
                </div>
            </div>

            <div class="territory-section">
                <h4>Political Factions</h4>

                <div class="faction-list" id="factionList">
                    <div class="territory-loading">Loading factions...</div>
                </div>
            </div>

            <div class="territory-section">
                <h4>Display Settings</h4>

                <div class="territory-opacity-control">
                    <label for="territoryOpacity">Territory Opacity</label>
                    <input type="range" id="territoryOpacity" class="territory-opacity-slider" min="0" max="1" step="0.1" value="0.3">
                    <div class="slider-value" id="territoryOpacityValue">30%</div>
                </div>

                <div class="border-width-control">
                    <label for="borderWidth">Border Width</label>
                    <input type="range" id="borderWidth" class="border-width-slider" min="1" max="5" step="1" value="2">
                    <div class="slider-value" id="borderWidthValue">2px</div>
                </div>

                <div class="animation-speed-control">
                    <label for="animationSpeed">Animation Speed</label>
                    <input type="range" id="animationSpeed" class="animation-speed-slider" min="0.1" max="3" step="0.1" value="1">
                    <div class="slider-value" id="animationSpeedValue">1x</div>
                </div>
            </div>

            <div class="territory-section">
                <h4>Animation</h4>

                <div class="territory-animation-controls">
                    <button class="territory-animation-btn" id="stopTerritoryAnimation">Stop Animation</button>
                </div>
            </div>

            <div class="territory-stats" id="territoryStats">
                <h4>Statistics</h4>
                <div class="territory-stat-row">
                    <span>Total Territories:</span>
                    <span class="territory-stat-value" id="totalTerritories">0</span>
                </div>
                <div class="territory-stat-row">
                    <span>Active Conflicts:</span>
                    <span class="territory-stat-value" id="activeConflicts">0</span>
                </div>
                <div class="territory-stat-row">
                    <span>Trade Routes:</span>
                    <span class="territory-stat-value" id="activeTradeRoutes">0</span>
                </div>
                <div class="territory-stat-row">
                    <span>Current Cycle:</span>
                    <span class="territory-stat-value" id="currentCycle">0</span>
                </div>
            </div>
        </div>

        <!-- Historical Snapshot Controls Panel -->
        <div class="snapshot-controls" id="snapshotControls">
            <h3>üì∏ Historical Snapshots</h3>

            <div class="snapshot-section">
                <h4>Snapshot Settings</h4>

                <div class="snapshot-toggle">
                    <input type="checkbox" id="snapshotsEnabled" checked>
                    <label for="snapshotsEnabled">Enable Snapshots</label>
                </div>

                <div class="snapshot-toggle">
                    <input type="checkbox" id="autoSnapshotEnabled" checked>
                    <label for="autoSnapshotEnabled">Auto-capture Events</label>
                </div>

                <div class="snapshot-toggle">
                    <input type="checkbox" id="snapshotMarkersEnabled" checked>
                    <label for="snapshotMarkersEnabled">Show Timeline Markers</label>
                </div>
            </div>

            <div class="snapshot-section">
                <h4>Create Snapshot</h4>

                <div class="snapshot-input-group">
                    <input type="text" id="snapshotTitle" placeholder="Snapshot title..." maxlength="100" class="snapshot-input">
                    <button class="snapshot-btn primary" id="captureSnapshot">üì∏ Capture</button>
                </div>

                <textarea id="snapshotDescription" placeholder="Optional description..." rows="2" class="snapshot-textarea"></textarea>

                <div class="snapshot-category-group">
                    <label for="snapshotCategory">Category:</label>
                    <select id="snapshotCategory" class="snapshot-select">
                        <option value="user_bookmark">User Bookmark</option>
                        <option value="milestone">Milestone</option>
                        <option value="conflict">Conflict</option>
                        <option value="event">Event</option>
                    </select>
                </div>
            </div>

            <div class="snapshot-section">
                <h4>Snapshot Settings</h4>

                <div class="max-snapshots-control">
                    <label for="maxSnapshots">Max Snapshots</label>
                    <input type="range" id="maxSnapshots" class="max-snapshots-slider" min="10" max="100" step="5" value="50">
                    <div class="slider-value" id="maxSnapshotsValue">50</div>
                </div>
            </div>

            <div class="snapshot-section">
                <h4>Saved Snapshots (<span id="snapshotCount">0</span>)</h4>

                <div class="snapshot-filter-group">
                    <select id="snapshotCategoryFilter" class="snapshot-filter">
                        <option value="all">All Categories</option>
                        <option value="user_bookmark">User Bookmarks</option>
                        <option value="auto_significant">Auto-captured</option>
                        <option value="milestone">Milestones</option>
                        <option value="conflict">Conflicts</option>
                        <option value="event">Events</option>
                    </select>
                </div>

                <div class="snapshot-list" id="snapshotList">
                    <div class="snapshot-loading">No snapshots yet...</div>
                </div>
            </div>

            <div class="snapshot-section">
                <h4>Snapshot Actions</h4>

                <div class="snapshot-action-controls">
                    <button class="snapshot-btn" id="exportSnapshots">Export All</button>
                    <button class="snapshot-btn secondary" id="clearSnapshots">Clear All</button>
                </div>
            </div>

            <div class="snapshot-stats" id="snapshotStats">
                <h4>Statistics</h4>
                <div class="snapshot-stat-row">
                    <span>Total Snapshots:</span>
                    <span class="snapshot-stat-value" id="totalSnapshots">0</span>
                </div>
                <div class="snapshot-stat-row">
                    <span>Auto-captured:</span>
                    <span class="snapshot-stat-value" id="autoSnapshots">0</span>
                </div>
                <div class="snapshot-stat-row">
                    <span>User Bookmarks:</span>
                    <span class="snapshot-stat-value" id="userSnapshots">0</span>
                </div>
                <div class="snapshot-stat-row">
                    <span>Storage Used:</span>
                    <span class="snapshot-stat-value" id="storageUsed">0 KB</span>
                </div>
            </div>
        </div>

        <!-- Temporal Data Export Controls Panel -->
        <div class="export-controls" id="exportControls">
            <h3>üìä Data Export</h3>

            <div class="export-section">
                <h4>Export Format</h4>
                <div class="format-selector">
                    <div class="format-option selected">
                        <input type="radio" id="formatJSON" name="exportFormat" value="json" checked>
                        <label for="formatJSON">JSON</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatCSV" name="exportFormat" value="csv">
                        <label for="formatCSV">CSV</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatXML" name="exportFormat" value="xml">
                        <label for="formatXML">XML</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatGeoJSON" name="exportFormat" value="geojson">
                        <label for="formatGeoJSON">GeoJSON</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatKML" name="exportFormat" value="kml">
                        <label for="formatKML">KML</label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="formatExcel" name="exportFormat" value="xlsx">
                        <label for="formatExcel">Excel</label>
                    </div>
                </div>
            </div>

            <div class="export-section">
                <h4>Data Categories</h4>
                <div class="category-selector">
                    <div class="category-option selected">
                        <label>
                            <input type="checkbox" id="includeEvents" checked>
                            Historical Events
                        </label>
                        <span class="category-count" id="eventsCount">0</span>
                    </div>
                    <div class="category-option selected">
                        <label>
                            <input type="checkbox" id="includeCharacters" checked>
                            Character Data
                        </label>
                        <span class="category-count" id="charactersCount">0</span>
                    </div>
                    <div class="category-option selected">
                        <label>
                            <input type="checkbox" id="includeJourneys" checked>
                            Character Journeys
                        </label>
                        <span class="category-count" id="journeysCount">0</span>
                    </div>
                    <div class="category-option selected">
                        <label>
                            <input type="checkbox" id="includeTerritories" checked>
                            Territory Data
                        </label>
                        <span class="category-count" id="territoriesCount">0</span>
                    </div>
                    <div class="category-option selected">
                        <label>
                            <input type="checkbox" id="includeSnapshots" checked>
                            Historical Snapshots
                        </label>
                        <span class="category-count" id="snapshotsCount">0</span>
                    </div>
                    <div class="category-option selected">
                        <label>
                            <input type="checkbox" id="includeMetadata" checked>
                            System Metadata
                        </label>
                        <span class="category-count" id="metadataCount">1</span>
                    </div>
                </div>
            </div>

            <div class="export-section">
                <h4>Export Options</h4>
                <div class="export-options">
                    <div class="export-toggle">
                        <label>
                            <input type="checkbox" id="compressData">
                            Compress Data
                        </label>
                    </div>
                    <div class="export-toggle">
                        <label>
                            <input type="checkbox" id="includeImages">
                            Include Images
                        </label>
                    </div>
                    <div class="export-toggle">
                        <label>
                            <input type="checkbox" id="timestampFilename" checked>
                            Timestamp Filename
                        </label>
                    </div>
                </div>
            </div>

            <div class="export-section">
                <h4>Export Actions</h4>
                <div class="export-actions">
                    <button class="export-btn primary" id="exportAllData">üìä Export All Data</button>
                    <button class="export-btn secondary" id="exportSelectedCategories">üìã Export Selected</button>
                </div>

                <div class="export-quick-actions">
                    <button class="quick-action-btn" id="exportEventsOnly">Events Only</button>
                    <button class="quick-action-btn" id="exportCharactersOnly">Characters Only</button>
                    <button class="quick-action-btn" id="exportTerritoriesOnly">Territories Only</button>
                    <button class="quick-action-btn" id="exportSnapshotsOnly">Snapshots Only</button>
                </div>
            </div>

            <div class="export-section">
                <h4>Export Progress</h4>
                <div class="export-progress" id="exportProgress">
                    <div class="progress-header">
                        <span class="progress-label">Ready to export</span>
                        <span class="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="file-size-indicator">
                    <span class="file-size-label">Estimated Size:</span>
                    <span class="file-size-value" id="estimatedSize">--</span>
                </div>
            </div>

            <div class="export-section">
                <h4>Export Statistics</h4>
                <div class="export-stats" id="exportStats">
                    <div class="export-stat-row">
                        <span>Formats Supported:</span>
                        <span class="export-stat-value" id="formatsSupported">6</span>
                    </div>
                    <div class="export-stat-row">
                        <span>Categories Available:</span>
                        <span class="export-stat-value" id="categoriesAvailable">6</span>
                    </div>
                    <div class="export-stat-row">
                        <span>Systems Registered:</span>
                        <span class="export-stat-value" id="systemsRegistered">0</span>
                    </div>
                    <div class="export-stat-row">
                        <span>Max File Size:</span>
                        <span class="export-stat-value" id="maxFileSize">50 MB</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load dependencies in order -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="../js/utils/timeConverter.js"></script>
    <script src="../js/components/maps/TemporalMapExtension.js"></script>
    <script src="../js/components/modals/EventCreationModal.js"></script>
    <script src="../js/components/visualizations/EpochOverlaySystem.js"></script>
    <script src="../js/components/visualizations/TemporalHeatMap.js"></script>
    <script src="../js/components/visualizations/CharacterJourneySystem.js"></script>
    <script src="../js/components/visualizations/TerritoryAnimationSystem.js"></script>
    <script src="../js/components/visualizations/HistoricalSnapshotSystem.js"></script>
    <script src="../js/components/visualizations/TemporalDataExportSystem.js"></script>

    <script>
        let map;
        let temporalExtension;
        let epochOverlaySystem;
        let temporalHeatMap;
        let characterJourneySystem;
        let territoryAnimationSystem;
        let historicalSnapshotSystem;
        let temporalDataExportSystem;

        // Initialize the temporal map
        async function initializeTemporalMap() {
            try {
                console.log('Initializing 4D Temporal Map...');

                // Create simple Leaflet map
                map = L.map('map').setView([0, 0], 3);

                // Add base tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);

                console.log('Base map initialized');

                // Create temporal extension
                temporalExtension = new TemporalMapExtension(map, {
                    initialCycle: 0,
                    animationSpeed: 1,
                    showHistoricalEvents: true,
                    onTimeChange: (cycle, day) => {
                        console.log(`Time changed to Cycle ${cycle}, Day ${day}`);
                        // Update epoch overlay system
                        if (epochOverlaySystem) {
                            epochOverlaySystem.updateEpochDisplay(cycle, true);
                        }
                        // Update heat map system
                        if (temporalHeatMap) {
                            temporalHeatMap.updateTimeRange(cycle - 50, cycle + 50);
                        }
                        // Update character journey system
                        if (characterJourneySystem) {
                            characterJourneySystem.updateTimeDisplay(cycle, day);
                        }
                        // Update territory animation system
                        if (territoryAnimationSystem) {
                            territoryAnimationSystem.updateTerritorialDisplay(cycle, true);
                        }
                        // Update browser title
                        updateWindowTitle(cycle, day);
                    }
                });

                console.log('Temporal extension initialized');

                // Create epoch overlay system
                epochOverlaySystem = new EpochOverlaySystem(map, {
                    enableOverlays: true,
                    showEraLabels: true,
                    animationDuration: 1500,
                    intensityMultiplier: 0.6
                });

                // Set initial epoch
                epochOverlaySystem.updateEpochDisplay(0, false);

                console.log('Epoch overlay system initialized');

                // Create temporal heat map system
                temporalHeatMap = new TemporalHeatMap(map, {
                    enableHeatMaps: true,
                    showControls: true,
                    showLegend: true,
                    defaultMode: 'density',
                    gridSize: 50,
                    intensityMultiplier: 0.7
                });

                console.log('Temporal heat map system initialized');

                // Create character journey system
                characterJourneySystem = new CharacterJourneySystem(map, {
                    enableJourneys: true,
                    showRelationships: true,
                    showLifeEvents: true,
                    showInfluenceZones: false,
                    pathOpacity: 0.7,
                    timeWindow: 100
                });

                console.log('Character journey system initialized');

                // Create territory animation system
                territoryAnimationSystem = new TerritoryAnimationSystem(map, {
                    enableTerritories: true,
                    showBorders: true,
                    showConflictZones: true,
                    showTradeRoutes: false,
                    territoryOpacity: 0.3,
                    smoothTransitions: true
                });

                console.log('Territory animation system initialized');

                // Create historical snapshot system
                historicalSnapshotSystem = new HistoricalSnapshotSystem(map, {
                    enableSnapshots: true,
                    autoSnapshot: true,
                    maxSnapshots: 50,
                    significanceThreshold: 0.7
                });

                // Register all visualization systems with snapshot system
                historicalSnapshotSystem.registerVisualizationSystem('epochSystem', epochOverlaySystem);
                historicalSnapshotSystem.registerVisualizationSystem('heatMapSystem', temporalHeatMap);
                historicalSnapshotSystem.registerVisualizationSystem('characterSystem', characterJourneySystem);
                historicalSnapshotSystem.registerVisualizationSystem('territorySystem', territoryAnimationSystem);

                console.log('Historical snapshot system initialized');

                // Create temporal data export system
                temporalDataExportSystem = new TemporalDataExportSystem(map, {
                    enableExport: true,
                    defaultFormat: 'json',
                    includeMetadata: true,
                    compressData: false,
                    maxFileSize: 50 * 1024 * 1024 // 50MB
                });

                // Register all visualization systems with export system
                temporalDataExportSystem.registerVisualizationSystem('temporalExtension', temporalExtension);
                temporalDataExportSystem.registerVisualizationSystem('epochSystem', epochOverlaySystem);
                temporalDataExportSystem.registerVisualizationSystem('heatMapSystem', temporalHeatMap);
                temporalDataExportSystem.registerVisualizationSystem('characterJourneySystem', characterJourneySystem);
                temporalDataExportSystem.registerVisualizationSystem('territoryAnimationSystem', territoryAnimationSystem);
                temporalDataExportSystem.registerVisualizationSystem('historicalSnapshotSystem', historicalSnapshotSystem);

                console.log('Temporal data export system initialized');

                // Initialize event creation modal
                window.eventModal = new EventCreationModal({
                    onEventCreated: (event) => {
                        console.log('New event created:', event);
                        // Refresh temporal markers to show new event
                        if (temporalExtension) {
                            temporalExtension.loadTemporalEvents();
                        }
                        // Update heat map with new event
                        if (temporalHeatMap) {
                            temporalHeatMap.refresh();
                        }
                        alert(`‚úÖ Event "${event.title}" created successfully!\n\nTime: ${event.formatted_time}\nLocation: ${event.latitude}, ${event.longitude}`);
                    },
                    onCancel: () => {
                        console.log('Event creation cancelled');
                    }
                });

                // Add right-click context menu for creating events
                map.on('contextmenu', (e) => {
                    const currentTime = temporalExtension.getCurrentTime();
                    window.eventModal.show({
                        initialLocation: {
                            lat: e.latlng.lat,
                            lon: e.latlng.lng
                        },
                        initialTime: currentTime
                    });
                });

                console.log('Event creation modal initialized');

                // Setup epoch controls
                setupEpochControls();

                // Setup character journey controls
                setupJourneyControls();

                // Setup territory controls
                setupTerritoryControls();

                // Setup snapshot controls
                setupSnapshotControls();

                // Setup export controls
                setupExportControls();

                // Add some sample markers to demonstrate spatial awareness
                const testMarker = L.marker([45.0, 10.0])
                    .addTo(map)
                    .bindPopup('Test Location - Click temporal controls to see events appear over time!');

                console.log('4D Temporal Map ready!');

                // Show instructions to user
                setTimeout(() => {
                    alert(`üåç‚è∞ 4D Temporal Map loaded successfully!

Instructions:
‚Ä¢ Use the temporal controls at the bottom to travel through time
‚Ä¢ Press ‚ñ∂ to play animation through history
‚Ä¢ Drag the timeline scrubber to jump to specific times
‚Ä¢ Historical events will appear/disappear based on current time
‚Ä¢ Click event markers to see details
‚Ä¢ Use quick jump buttons to visit different eras
‚Ä¢ RIGHT-CLICK on the map to create new historical events at that location

Event Creation:
‚Ä¢ Right-click anywhere on the map to open event creation modal
‚Ä¢ The modal will use the current map position and timeline time
‚Ä¢ Fill in event details, participants, and relationships
‚Ä¢ New events will appear on the map at their time

Current time: Cycle 0, Day 1 (Present Day)`);
                }, 1000);

            } catch (error) {
                console.error('Error initializing temporal map:', error);
                alert('Error loading temporal map. Please check the console for details.');
            }
        }

        // Update browser title with current time
        function updateWindowTitle(cycle, day) {
            if (typeof timeConverter !== 'undefined') {
                const timeString = timeConverter.cycleToShort(cycle, day);
                const era = timeConverter.getEra(cycle);
                document.title = `4D Map - ${timeString} (${era})`;
            }
        }

        // Setup epoch controls event handlers
        function setupEpochControls() {
            if (!epochOverlaySystem) return;

            // Epoch overlays toggle
            document.getElementById('epochOverlaysEnabled').addEventListener('change', (e) => {
                epochOverlaySystem.setEpochOverlayEnabled(e.target.checked);
            });

            // Era labels toggle
            document.getElementById('eraLabelsEnabled').addEventListener('change', (e) => {
                epochOverlaySystem.setEraLabelsEnabled(e.target.checked);
            });

            // Epoch boundaries toggle
            document.getElementById('epochBoundariesEnabled').addEventListener('change', (e) => {
                epochOverlaySystem.showEpochBoundaries(e.target.checked);
            });

            // Intensity slider
            const intensitySlider = document.getElementById('epochIntensity');
            const intensityValue = document.getElementById('intensityValue');

            intensitySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                epochOverlaySystem.setIntensity(value);
                intensityValue.textContent = `${Math.round(value * 100)}%`;
            });

            // Transitions toggle (this could control animation duration)
            document.getElementById('epochTransitionsEnabled').addEventListener('change', (e) => {
                epochOverlaySystem.options.animationDuration = e.target.checked ? 1500 : 0;
            });
        }

        // Setup character journey controls event handlers
        function setupJourneyControls() {
            if (!characterJourneySystem) return;

            // Journey paths toggle
            document.getElementById('journeysEnabled').addEventListener('change', (e) => {
                characterJourneySystem.setJourneysEnabled(e.target.checked);
            });

            // Relationships toggle
            document.getElementById('relationshipsEnabled').addEventListener('change', (e) => {
                characterJourneySystem.setRelationshipsEnabled(e.target.checked);
            });

            // Life events toggle
            document.getElementById('lifeEventsEnabled').addEventListener('change', (e) => {
                // This would be implemented in the journey system
                console.log('Life events toggle:', e.target.checked);
            });

            // Influence zones toggle
            document.getElementById('influenceZonesEnabled').addEventListener('change', (e) => {
                characterJourneySystem.setInfluenceZonesEnabled(e.target.checked);
            });

            // Character selection controls
            document.getElementById('selectAllCharacters').addEventListener('click', () => {
                characterJourneySystem.selectAllCharacters();
                updateCharacterList();
                updateJourneyStats();
            });

            document.getElementById('deselectAllCharacters').addEventListener('click', () => {
                characterJourneySystem.deselectAllCharacters();
                updateCharacterList();
                updateJourneyStats();
            });

            // Path opacity slider
            const pathOpacitySlider = document.getElementById('pathOpacity');
            const pathOpacityValue = document.getElementById('pathOpacityValue');

            pathOpacitySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                characterJourneySystem.setPathOpacity(value);
                pathOpacityValue.textContent = `${Math.round(value * 100)}%`;
            });

            // Time window slider
            const timeWindowSlider = document.getElementById('timeWindow');
            const timeWindowValue = document.getElementById('timeWindowValue');

            timeWindowSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                characterJourneySystem.setTimeWindow(value);
                timeWindowValue.textContent = `${value} cycles`;
            });

            // Animation controls
            document.getElementById('playJourneyAnimation').addEventListener('click', () => {
                const selectedCharacters = characterJourneySystem.getCharacterList().filter(char => char.selected);
                if (selectedCharacters.length > 0) {
                    characterJourneySystem.playJourneyAnimation(selectedCharacters[0].id);
                    document.getElementById('playJourneyAnimation').disabled = true;
                    document.getElementById('stopJourneyAnimation').disabled = false;
                } else {
                    alert('Please select a character first');
                }
            });

            document.getElementById('stopJourneyAnimation').addEventListener('click', () => {
                characterJourneySystem.stopAnimation();
                document.getElementById('playJourneyAnimation').disabled = false;
                document.getElementById('stopJourneyAnimation').disabled = true;
            });

            // Set initial states
            document.getElementById('stopJourneyAnimation').disabled = true;

            // Listen for character selection events
            map.on('characterSelected', updateCharacterList);
            map.on('characterDeselected', updateCharacterList);

            // Initial setup
            setTimeout(() => {
                updateCharacterList();
                updateJourneyStats();
            }, 1000); // Give time for character data to load
        }

        function updateCharacterList() {
            if (!characterJourneySystem) return;

            const characterList = document.getElementById('characterList');
            const characters = characterJourneySystem.getCharacterList();

            if (characters.length === 0) {
                characterList.innerHTML = '<div class="journey-loading">Loading characters...</div>';
                return;
            }

            characterList.innerHTML = characters.map(character => `
                <div class="character-item ${character.selected ? 'selected' : ''}"
                     data-character-id="${character.id}"
                     data-type="${character.type}">
                    <div class="character-color" style="background-color: ${character.color || '#95a5a6'}"></div>
                    <div class="character-info">
                        <div class="character-name">${character.name}</div>
                        <div class="character-details">${character.type} | ${character.lifespan}</div>
                    </div>
                </div>
            `).join('');

            // Add click handlers for character items
            characterList.querySelectorAll('.character-item').forEach(item => {
                item.addEventListener('click', () => {
                    const characterId = item.dataset.characterId;
                    const isSelected = item.classList.contains('selected');

                    if (isSelected) {
                        characterJourneySystem.deselectCharacter(characterId);
                    } else {
                        characterJourneySystem.selectCharacter(characterId);
                    }

                    updateCharacterList();
                    updateJourneyStats();
                });
            });
        }

        function updateJourneyStats() {
            if (!characterJourneySystem) return;

            const stats = characterJourneySystem.getStats();

            document.getElementById('totalCharacters').textContent = stats.totalCharacters;
            document.getElementById('selectedCharacters').textContent = stats.selectedCharacters;
            document.getElementById('totalEvents').textContent = stats.totalEvents;
            document.getElementById('totalRelationships').textContent = stats.totalRelationships;
        }

        // Setup territory controls event handlers
        function setupTerritoryControls() {
            if (!territoryAnimationSystem) return;

            // Territory visualization toggles
            document.getElementById('territoriesEnabled').addEventListener('change', (e) => {
                territoryAnimationSystem.setTerritoriesEnabled(e.target.checked);
            });

            document.getElementById('bordersEnabled').addEventListener('change', (e) => {
                territoryAnimationSystem.setBordersEnabled(e.target.checked);
            });

            document.getElementById('conflictZonesEnabled').addEventListener('change', (e) => {
                territoryAnimationSystem.setConflictZonesEnabled(e.target.checked);
            });

            document.getElementById('tradeRoutesEnabled').addEventListener('change', (e) => {
                territoryAnimationSystem.setTradeRoutesEnabled(e.target.checked);
            });

            document.getElementById('smoothTransitionsEnabled').addEventListener('change', (e) => {
                territoryAnimationSystem.setSmoothTransitions(e.target.checked);
            });

            // Territory opacity slider
            const territoryOpacitySlider = document.getElementById('territoryOpacity');
            const territoryOpacityValue = document.getElementById('territoryOpacityValue');

            territoryOpacitySlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                territoryAnimationSystem.setTerritoryOpacity(value);
                territoryOpacityValue.textContent = `${Math.round(value * 100)}%`;
            });

            // Border width slider
            const borderWidthSlider = document.getElementById('borderWidth');
            const borderWidthValue = document.getElementById('borderWidthValue');

            borderWidthSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                territoryAnimationSystem.setBorderWidth(value);
                borderWidthValue.textContent = `${value}px`;
            });

            // Animation speed slider
            const animationSpeedSlider = document.getElementById('animationSpeed');
            const animationSpeedValue = document.getElementById('animationSpeedValue');

            animationSpeedSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                territoryAnimationSystem.setAnimationSpeed(value);
                animationSpeedValue.textContent = `${value}x`;
            });

            // Stop animation button
            document.getElementById('stopTerritoryAnimation').addEventListener('click', () => {
                territoryAnimationSystem.stopAnimation();
            });

            // Initial setup
            setTimeout(() => {
                updateFactionList();
                updateTerritoryStats();
            }, 1000); // Give time for territory data to load
        }

        function updateFactionList() {
            if (!territoryAnimationSystem) return;

            const factionList = document.getElementById('factionList');
            const factions = territoryAnimationSystem.getFactionList();

            if (factions.length === 0) {
                factionList.innerHTML = '<div class="territory-loading">Loading factions...</div>';
                return;
            }

            factionList.innerHTML = factions.map(faction => `
                <div class="faction-item"
                     data-faction-id="${faction.id}"
                     data-type="${faction.pattern}">
                    <div class="faction-color" style="background-color: ${faction.color}"></div>
                    <div class="faction-info">
                        <div class="faction-name">${faction.name}</div>
                        <div class="faction-details">${faction.territories} territories <span class="faction-pattern">${faction.pattern}</span></div>
                    </div>
                </div>
            `).join('');

            // Add click handlers for faction items
            factionList.querySelectorAll('.faction-item').forEach(item => {
                item.addEventListener('click', () => {
                    const factionId = item.dataset.factionId;
                    const isHighlighted = item.classList.contains('highlighted');

                    // Clear all highlights first
                    factionList.querySelectorAll('.faction-item').forEach(i => {
                        i.classList.remove('highlighted');
                        const id = i.dataset.factionId;
                        territoryAnimationSystem.highlightFaction(id, false);
                    });

                    if (!isHighlighted) {
                        item.classList.add('highlighted');
                        territoryAnimationSystem.highlightFaction(factionId, true);
                    }
                });
            });
        }

        function updateTerritoryStats() {
            if (!territoryAnimationSystem) return;

            const stats = territoryAnimationSystem.getTerritorialStats();

            document.getElementById('totalTerritories').textContent = stats.totalTerritories;
            document.getElementById('activeConflicts').textContent = stats.activeConflicts;
            document.getElementById('activeTradeRoutes').textContent = stats.activeTradeRoutes;
            document.getElementById('currentCycle').textContent = stats.currentCycle;
        }

        // Setup snapshot controls event handlers
        function setupSnapshotControls() {
            if (!historicalSnapshotSystem) return;

            // Snapshot settings toggles
            document.getElementById('snapshotsEnabled').addEventListener('change', (e) => {
                historicalSnapshotSystem.setSnapshotsEnabled(e.target.checked);
            });

            document.getElementById('autoSnapshotEnabled').addEventListener('change', (e) => {
                historicalSnapshotSystem.setAutoSnapshot(e.target.checked);
            });

            document.getElementById('snapshotMarkersEnabled').addEventListener('change', (e) => {
                historicalSnapshotSystem.setTimelineMarkersEnabled(e.target.checked);
            });

            // Capture snapshot button
            document.getElementById('captureSnapshot').addEventListener('click', async () => {
                const title = document.getElementById('snapshotTitle').value || 'Untitled Snapshot';
                const description = document.getElementById('snapshotDescription').value || '';
                const category = document.getElementById('snapshotCategory').value;

                try {
                    const snapshot = await historicalSnapshotSystem.captureCurrentState(title, description, category);
                    console.log('Snapshot captured:', snapshot);

                    // Clear input fields
                    document.getElementById('snapshotTitle').value = '';
                    document.getElementById('snapshotDescription').value = '';

                    // Update snapshot list
                    updateSnapshotList();
                    updateSnapshotStats();

                    // Show success feedback
                    const button = document.getElementById('captureSnapshot');
                    const originalText = button.textContent;
                    button.textContent = '‚úì Captured!';
                    button.style.background = '#27ae60';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '';
                    }, 2000);
                } catch (error) {
                    console.error('Error capturing snapshot:', error);
                    alert('Error capturing snapshot: ' + error.message);
                }
            });

            // Max snapshots slider
            const maxSnapshotsSlider = document.getElementById('maxSnapshots');
            const maxSnapshotsValue = document.getElementById('maxSnapshotsValue');

            maxSnapshotsSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                historicalSnapshotSystem.setMaxSnapshots(value);
                maxSnapshotsValue.textContent = value;
            });

            // Category filter
            document.getElementById('snapshotCategoryFilter').addEventListener('change', (e) => {
                updateSnapshotList(e.target.value);
            });

            // Export snapshots button
            document.getElementById('exportSnapshots').addEventListener('click', () => {
                try {
                    historicalSnapshotSystem.exportSnapshots();
                } catch (error) {
                    console.error('Error exporting snapshots:', error);
                    alert('Error exporting snapshots: ' + error.message);
                }
            });

            // Clear snapshots button
            document.getElementById('clearSnapshots').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all snapshots? This cannot be undone.')) {
                    historicalSnapshotSystem.clearAllSnapshots();
                    updateSnapshotList();
                    updateSnapshotStats();
                }
            });

            // Initial setup
            setTimeout(() => {
                updateSnapshotList();
                updateSnapshotStats();
            }, 1000); // Give time for snapshot data to load
        }

        function updateSnapshotList(categoryFilter = 'all') {
            if (!historicalSnapshotSystem) return;

            const snapshotList = document.getElementById('snapshotList');
            const snapshots = historicalSnapshotSystem.getSnapshotList(categoryFilter);

            if (snapshots.length === 0) {
                snapshotList.innerHTML = '<div class="snapshot-loading">No snapshots available...</div>';
                return;
            }

            snapshotList.innerHTML = snapshots.map(snapshot => `
                <div class="snapshot-item" data-snapshot-id="${snapshot.id}">
                    <div class="snapshot-header">
                        <div class="snapshot-title">${snapshot.title}</div>
                        <div class="snapshot-timestamp">${new Date(snapshot.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="snapshot-details">
                        <div class="snapshot-category">${snapshot.category}</div>
                        <div class="snapshot-significance">Significance: ${(snapshot.significance * 100).toFixed(0)}%</div>
                    </div>
                    ${snapshot.description ? `<div class="snapshot-description">${snapshot.description}</div>` : ''}
                    <div class="snapshot-actions">
                        <button class="snapshot-action-btn restore" data-action="restore">Restore</button>
                        <button class="snapshot-action-btn view" data-action="view">View Details</button>
                        <button class="snapshot-action-btn delete" data-action="delete">Delete</button>
                    </div>
                </div>
            `).join('');

            // Add click handlers for snapshot actions
            snapshotList.querySelectorAll('.snapshot-action-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const action = button.dataset.action;
                    const snapshotItem = button.closest('.snapshot-item');
                    const snapshotId = snapshotItem.dataset.snapshotId;

                    try {
                        switch (action) {
                            case 'restore':
                                if (confirm('Restore this snapshot? This will change the current world state.')) {
                                    await historicalSnapshotSystem.restoreSnapshot(snapshotId);
                                    alert('Snapshot restored successfully!');
                                }
                                break;
                            case 'view':
                                const snapshot = historicalSnapshotSystem.getSnapshot(snapshotId);
                                const detailsModal = `
                                    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                                        <h3>${snapshot.title}</h3>
                                        <p><strong>Created:</strong> ${new Date(snapshot.timestamp).toLocaleString()}</p>
                                        <p><strong>Category:</strong> ${snapshot.category}</p>
                                        <p><strong>Significance:</strong> ${(snapshot.significance * 100).toFixed(1)}%</p>
                                        ${snapshot.description ? `<p><strong>Description:</strong> ${snapshot.description}</p>` : ''}
                                        <p><strong>Data Size:</strong> ${JSON.stringify(snapshot.worldState).length} characters</p>
                                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px;">Close</button>
                                    </div>
                                `;
                                const overlay = document.createElement('div');
                                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                                overlay.innerHTML = detailsModal;
                                overlay.addEventListener('click', (e) => {
                                    if (e.target === overlay) overlay.remove();
                                });
                                document.body.appendChild(overlay);
                                break;
                            case 'delete':
                                if (confirm('Delete this snapshot? This cannot be undone.')) {
                                    historicalSnapshotSystem.deleteSnapshot(snapshotId);
                                    updateSnapshotList(categoryFilter);
                                    updateSnapshotStats();
                                }
                                break;
                        }
                    } catch (error) {
                        console.error(`Error ${action}ing snapshot:`, error);
                        alert(`Error ${action}ing snapshot: ` + error.message);
                    }
                });
            });

            // Update snapshot count
            document.getElementById('snapshotCount').textContent = snapshots.length;
        }

        function updateSnapshotStats() {
            if (!historicalSnapshotSystem) return;

            const stats = historicalSnapshotSystem.getSnapshotStats();

            document.getElementById('totalSnapshots').textContent = stats.totalSnapshots;
            document.getElementById('autoSnapshots').textContent = stats.autoSnapshots;
            document.getElementById('userSnapshots').textContent = stats.userSnapshots;
            document.getElementById('storageUsed').textContent = `${(stats.storageUsed / 1024).toFixed(1)} KB`;
        }

        // Setup export controls event handlers
        function setupExportControls() {
            if (!temporalDataExportSystem) return;

            // Format selection
            document.querySelectorAll('input[name="exportFormat"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    // Update format selection UI
                    document.querySelectorAll('.format-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    e.target.closest('.format-option').classList.add('selected');
                    updateEstimatedSize();
                });
            });

            // Category checkboxes
            document.querySelectorAll('input[type="checkbox"][id^="include"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const categoryOption = e.target.closest('.category-option');
                    if (e.target.checked) {
                        categoryOption.classList.add('selected');
                    } else {
                        categoryOption.classList.remove('selected');
                    }
                    updateEstimatedSize();
                });
            });

            // Export all data button
            document.getElementById('exportAllData').addEventListener('click', async () => {
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                const options = getExportOptions();

                try {
                    updateExportProgress('Preparing export...', 0);
                    const result = await temporalDataExportSystem.exportAllData(format, options);

                    updateExportProgress('Export completed!', 100);
                    setTimeout(() => {
                        resetExportProgress();
                        showExportSuccess(result);
                    }, 2000);
                } catch (error) {
                    console.error('Export failed:', error);
                    showExportError(error.message);
                    resetExportProgress();
                }
            });

            // Export selected categories button
            document.getElementById('exportSelectedCategories').addEventListener('click', async () => {
                const format = document.querySelector('input[name="exportFormat"]:checked').value;
                const options = getExportOptions();

                // Check if any categories are selected
                const selectedCategories = getSelectedCategories();
                if (selectedCategories.length === 0) {
                    alert('Please select at least one data category to export.');
                    return;
                }

                try {
                    updateExportProgress('Preparing export...', 0);
                    const result = await temporalDataExportSystem.exportAllData(format, options);

                    updateExportProgress('Export completed!', 100);
                    setTimeout(() => {
                        resetExportProgress();
                        showExportSuccess(result);
                    }, 2000);
                } catch (error) {
                    console.error('Export failed:', error);
                    showExportError(error.message);
                    resetExportProgress();
                }
            });

            // Quick action buttons
            document.getElementById('exportEventsOnly').addEventListener('click', async () => {
                await exportSingleCategory('events');
            });

            document.getElementById('exportCharactersOnly').addEventListener('click', async () => {
                await exportSingleCategory('characters');
            });

            document.getElementById('exportTerritoriesOnly').addEventListener('click', async () => {
                await exportSingleCategory('territories');
            });

            document.getElementById('exportSnapshotsOnly').addEventListener('click', async () => {
                await exportSingleCategory('snapshots');
            });

            // Initial setup
            setTimeout(() => {
                updateDataCounts();
                updateExportStats();
                updateEstimatedSize();
            }, 1000);

            // Monitor export progress
            const progressInterval = setInterval(() => {
                if (temporalDataExportSystem.isExportInProgress()) {
                    const progress = temporalDataExportSystem.getExportProgress();
                    updateExportProgress('Exporting data...', progress);
                }
            }, 500);
        }

        async function exportSingleCategory(category) {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;

            try {
                updateExportProgress(`Exporting ${category}...`, 0);
                const result = await temporalDataExportSystem.exportCategory(category, format);

                updateExportProgress('Export completed!', 100);
                setTimeout(() => {
                    resetExportProgress();
                    showExportSuccess(result);
                }, 2000);
            } catch (error) {
                console.error(`Export failed for ${category}:`, error);
                showExportError(error.message);
                resetExportProgress();
            }
        }

        function getExportOptions() {
            return {
                includeEvents: document.getElementById('includeEvents').checked,
                includeCharacters: document.getElementById('includeCharacters').checked,
                includeJourneys: document.getElementById('includeJourneys').checked,
                includeTerritories: document.getElementById('includeTerritories').checked,
                includeSnapshots: document.getElementById('includeSnapshots').checked,
                includeMetadata: document.getElementById('includeMetadata').checked,
                compressData: document.getElementById('compressData').checked,
                includeImages: document.getElementById('includeImages').checked,
                timestampFilename: document.getElementById('timestampFilename').checked
            };
        }

        function getSelectedCategories() {
            const categories = [];
            if (document.getElementById('includeEvents').checked) categories.push('events');
            if (document.getElementById('includeCharacters').checked) categories.push('characters');
            if (document.getElementById('includeJourneys').checked) categories.push('journeys');
            if (document.getElementById('includeTerritories').checked) categories.push('territories');
            if (document.getElementById('includeSnapshots').checked) categories.push('snapshots');
            if (document.getElementById('includeMetadata').checked) categories.push('metadata');
            return categories;
        }

        function updateExportProgress(label, percentage) {
            document.querySelector('.progress-label').textContent = label;
            document.querySelector('.progress-percentage').textContent = `${Math.round(percentage)}%`;
            document.querySelector('.progress-fill').style.width = `${percentage}%`;

            const progressDiv = document.getElementById('exportProgress');
            if (percentage > 0 && percentage < 100) {
                progressDiv.classList.add('active');
            } else {
                progressDiv.classList.remove('active');
            }
        }

        function resetExportProgress() {
            updateExportProgress('Ready to export', 0);
        }

        function updateDataCounts() {
            // Update category counts based on available data
            // These would be updated from the actual systems
            document.getElementById('eventsCount').textContent = '3'; // Sample data
            document.getElementById('charactersCount').textContent = '2';
            document.getElementById('journeysCount').textContent = '2';
            document.getElementById('territoriesCount').textContent = '2';

            // Get actual snapshot count
            if (historicalSnapshotSystem) {
                const snapshotStats = historicalSnapshotSystem.getSnapshotStats();
                document.getElementById('snapshotsCount').textContent = snapshotStats.totalSnapshots;
            }
        }

        function updateExportStats() {
            if (!temporalDataExportSystem) return;

            const stats = temporalDataExportSystem.getExportStats();
            document.getElementById('formatsSupported').textContent = stats.formatsSupported;
            document.getElementById('categoriesAvailable').textContent = stats.categoriesSupported;
            document.getElementById('systemsRegistered').textContent = stats.systemsRegistered;
            document.getElementById('maxFileSize').textContent = `${Math.round(stats.maxFileSize / (1024 * 1024))} MB`;
        }

        function updateEstimatedSize() {
            // Estimate export size based on selected format and categories
            const selectedCategories = getSelectedCategories();
            const format = document.querySelector('input[name="exportFormat"]:checked').value;

            let estimatedKB = 0;
            selectedCategories.forEach(category => {
                switch (category) {
                    case 'events': estimatedKB += 15; break;
                    case 'characters': estimatedKB += 8; break;
                    case 'journeys': estimatedKB += 12; break;
                    case 'territories': estimatedKB += 20; break;
                    case 'snapshots': estimatedKB += historicalSnapshotSystem ? historicalSnapshotSystem.getSnapshotStats().storageUsed / 1024 : 0; break;
                    case 'metadata': estimatedKB += 2; break;
                }
            });

            // Format multipliers
            const formatMultipliers = {
                json: 1.0,
                csv: 0.8,
                xml: 1.3,
                geojson: 1.1,
                kml: 1.4,
                xlsx: 0.9
            };

            estimatedKB *= formatMultipliers[format] || 1.0;

            const sizeStr = estimatedKB > 1024 ?
                `${(estimatedKB / 1024).toFixed(1)} MB` :
                `${Math.round(estimatedKB)} KB`;

            document.getElementById('estimatedSize').textContent = sizeStr;
        }

        function showExportSuccess(result) {
            const status = document.createElement('div');
            status.className = 'export-status success';
            status.innerHTML = `‚úÖ Export completed: ${result.filename} (${(result.size / 1024).toFixed(1)} KB)`;

            const exportSection = document.querySelector('.export-actions').parentNode;
            exportSection.appendChild(status);

            setTimeout(() => status.remove(), 5000);
        }

        function showExportError(message) {
            const status = document.createElement('div');
            status.className = 'export-status error';
            status.innerHTML = `‚ùå Export failed: ${message}`;

            const exportSection = document.querySelector('.export-actions').parentNode;
            exportSection.appendChild(status);

            setTimeout(() => status.remove(), 5000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!temporalExtension) return;

            switch(e.key) {
                case ' ': // Spacebar
                    e.preventDefault();
                    temporalExtension.togglePlayback();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    temporalExtension.stepTime(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    temporalExtension.stepTime(1);
                    break;
                case 'Home':
                    e.preventDefault();
                    temporalExtension.jumpToTime(0, 1); // Jump to present
                    break;
                case 'r':
                case 'R':
                    if (e.ctrlKey || e.metaKey) return; // Don't interfere with refresh
                    e.preventDefault();
                    temporalExtension.jumpToTime(0, 1); // Reset to present
                    break;
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing temporal map...');
            initializeTemporalMap();
        });

        // Global functions for console debugging
        window.jumpToAncientPast = () => {
            if (temporalExtension) {
                temporalExtension.jumpToTime(-5000, 1);
            }
        };

        window.jumpToFoundations = () => {
            if (temporalExtension) {
                temporalExtension.jumpToTime(-500, 1);
            }
        };

        window.jumpToPresent = () => {
            if (temporalExtension) {
                temporalExtension.jumpToTime(0, 1);
            }
        };

        window.jumpToFuture = () => {
            if (temporalExtension) {
                temporalExtension.jumpToTime(500, 1);
            }
        };

        window.playAnimation = () => {
            if (temporalExtension && !temporalExtension.isPlaying) {
                temporalExtension.play();
            }
        };

        window.pauseAnimation = () => {
            if (temporalExtension && temporalExtension.isPlaying) {
                temporalExtension.pause();
            }
        };

        // Event creation debug functions
        window.createEventAtLocation = (lat, lon) => {
            if (window.eventModal && temporalExtension) {
                const currentTime = temporalExtension.getCurrentTime();
                window.eventModal.show({
                    initialLocation: { lat, lon },
                    initialTime: currentTime
                });
            }
        };

        window.createEventHere = () => {
            if (map && window.eventModal && temporalExtension) {
                const center = map.getCenter();
                const currentTime = temporalExtension.getCurrentTime();
                window.eventModal.show({
                    initialLocation: { lat: center.lat, lon: center.lng },
                    initialTime: currentTime
                });
            }
        };

        window.showEventModal = () => {
            if (window.eventModal) {
                window.eventModal.show();
            }
        };

        // Epoch overlay debug functions
        window.toggleEpochOverlays = () => {
            if (epochOverlaySystem) {
                const checkbox = document.getElementById('epochOverlaysEnabled');
                checkbox.checked = !checkbox.checked;
                epochOverlaySystem.setEpochOverlayEnabled(checkbox.checked);
            }
        };

        window.setEpochIntensity = (intensity) => {
            if (epochOverlaySystem) {
                const slider = document.getElementById('epochIntensity');
                slider.value = intensity;
                epochOverlaySystem.setIntensity(intensity);
                document.getElementById('intensityValue').textContent = `${Math.round(intensity * 100)}%`;
            }
        };

        window.showEpochInfo = () => {
            if (epochOverlaySystem && temporalExtension) {
                const currentTime = temporalExtension.getCurrentTime();
                const epoch = epochOverlaySystem.getEpochInfo(currentTime.cycle);
                console.log('Current Epoch:', epoch);
                alert(`Current Era: ${epoch.name}\nTime Range: Cycles ${epoch.cycleStart} to ${epoch.cycleEnd}\nDescription: ${epoch.description}\nColor: ${epoch.color}`);
            }
        };

        // Heat map debug functions
        window.toggleHeatMap = () => {
            if (temporalHeatMap) {
                temporalHeatMap.toggleHeatMap();
            }
        };

        window.setHeatMapMode = (mode) => {
            if (temporalHeatMap) {
                temporalHeatMap.setMode(mode);
                console.log(`Heat map mode set to: ${mode}`);
            }
        };

        window.setHeatMapIntensity = (intensity) => {
            if (temporalHeatMap) {
                temporalHeatMap.setIntensity(intensity);
                console.log(`Heat map intensity set to: ${intensity}`);
            }
        };

        window.setHeatMapGridSize = (size) => {
            if (temporalHeatMap) {
                temporalHeatMap.setGridSize(size);
                console.log(`Heat map grid size set to: ${size}`);
            }
        };

        window.refreshHeatMap = () => {
            if (temporalHeatMap) {
                temporalHeatMap.refresh();
                console.log('Heat map refreshed');
            }
        };

        window.showHeatMapStats = () => {
            if (temporalHeatMap) {
                const stats = temporalHeatMap.getStats();
                console.log('Heat Map Statistics:', stats);
                alert(`Heat Map Statistics:
Mode: ${stats.mode}
Grid Size: ${stats.gridSize}
Events Loaded: ${stats.eventsLoaded}
Cells Rendered: ${stats.cellsRendered}
Time Range: ${stats.timeRange.start} to ${stats.timeRange.end}
Max Value: ${stats.maxValue.toFixed(2)}
Visible Cells: ${stats.visibleCells}`);
            }
        };

        // Character journey debug functions
        window.toggleJourneys = () => {
            if (characterJourneySystem) {
                const checkbox = document.getElementById('journeysEnabled');
                checkbox.checked = !checkbox.checked;
                characterJourneySystem.setJourneysEnabled(checkbox.checked);
            }
        };

        window.selectCharacter = (characterId) => {
            if (characterJourneySystem) {
                characterJourneySystem.selectCharacter(characterId);
                updateCharacterList();
                updateJourneyStats();
            }
        };

        window.playCharacterJourney = (characterId) => {
            if (characterJourneySystem) {
                characterJourneySystem.playJourneyAnimation(characterId || 'char_1');
            }
        };

        window.setJourneyOpacity = (opacity) => {
            if (characterJourneySystem) {
                const slider = document.getElementById('pathOpacity');
                slider.value = opacity;
                characterJourneySystem.setPathOpacity(opacity);
                document.getElementById('pathOpacityValue').textContent = `${Math.round(opacity * 100)}%`;
            }
        };

        window.setJourneyTimeWindow = (window) => {
            if (characterJourneySystem) {
                const slider = document.getElementById('timeWindow');
                slider.value = window;
                characterJourneySystem.setTimeWindow(window);
                document.getElementById('timeWindowValue').textContent = `${window} cycles`;
            }
        };

        window.showJourneyStats = () => {
            if (characterJourneySystem) {
                const stats = characterJourneySystem.getStats();
                console.log('Character Journey Statistics:', stats);
                alert(`Character Journey Statistics:
Total Characters: ${stats.totalCharacters}
Selected Characters: ${stats.selectedCharacters}
Total Life Events: ${stats.totalEvents}
Total Relationships: ${stats.totalRelationships}
Time Window: ${stats.currentTimeWindow} cycles
Animation Running: ${stats.isAnimating}`);
            }
        };

        window.getCharacterList = () => {
            if (characterJourneySystem) {
                const characters = characterJourneySystem.getCharacterList();
                console.log('Available Characters:', characters);
                return characters;
            }
        };

        window.selectAllCharacters = () => {
            if (characterJourneySystem) {
                characterJourneySystem.selectAllCharacters();
                updateCharacterList();
                updateJourneyStats();
            }
        };

        window.deselectAllCharacters = () => {
            if (characterJourneySystem) {
                characterJourneySystem.deselectAllCharacters();
                updateCharacterList();
                updateJourneyStats();
            }
        };

        window.toggleRelationships = () => {
            if (characterJourneySystem) {
                const checkbox = document.getElementById('relationshipsEnabled');
                checkbox.checked = !checkbox.checked;
                characterJourneySystem.setRelationshipsEnabled(checkbox.checked);
            }
        };

        window.toggleInfluenceZones = () => {
            if (characterJourneySystem) {
                const checkbox = document.getElementById('influenceZonesEnabled');
                checkbox.checked = !checkbox.checked;
                characterJourneySystem.setInfluenceZonesEnabled(checkbox.checked);
            }
        };

        // Territory animation debug functions
        window.toggleTerritories = () => {
            if (territoryAnimationSystem) {
                const checkbox = document.getElementById('territoriesEnabled');
                checkbox.checked = !checkbox.checked;
                territoryAnimationSystem.setTerritoriesEnabled(checkbox.checked);
            }
        };

        window.toggleBorders = () => {
            if (territoryAnimationSystem) {
                const checkbox = document.getElementById('bordersEnabled');
                checkbox.checked = !checkbox.checked;
                territoryAnimationSystem.setBordersEnabled(checkbox.checked);
            }
        };

        window.toggleConflictZones = () => {
            if (territoryAnimationSystem) {
                const checkbox = document.getElementById('conflictZonesEnabled');
                checkbox.checked = !checkbox.checked;
                territoryAnimationSystem.setConflictZonesEnabled(checkbox.checked);
            }
        };

        window.toggleTradeRoutes = () => {
            if (territoryAnimationSystem) {
                const checkbox = document.getElementById('tradeRoutesEnabled');
                checkbox.checked = !checkbox.checked;
                territoryAnimationSystem.setTradeRoutesEnabled(checkbox.checked);
            }
        };

        window.setTerritoryOpacity = (opacity) => {
            if (territoryAnimationSystem) {
                const slider = document.getElementById('territoryOpacity');
                slider.value = opacity;
                territoryAnimationSystem.setTerritoryOpacity(opacity);
                document.getElementById('territoryOpacityValue').textContent = `${Math.round(opacity * 100)}%`;
            }
        };

        window.setBorderWidth = (width) => {
            if (territoryAnimationSystem) {
                const slider = document.getElementById('borderWidth');
                slider.value = width;
                territoryAnimationSystem.setBorderWidth(width);
                document.getElementById('borderWidthValue').textContent = `${width}px`;
            }
        };

        window.setTerritoryAnimationSpeed = (speed) => {
            if (territoryAnimationSystem) {
                const slider = document.getElementById('animationSpeed');
                slider.value = speed;
                territoryAnimationSystem.setAnimationSpeed(speed);
                document.getElementById('animationSpeedValue').textContent = `${speed}x`;
            }
        };

        window.highlightFaction = (factionId) => {
            if (territoryAnimationSystem) {
                territoryAnimationSystem.highlightFaction(factionId, true);
                // Update UI
                const factionList = document.getElementById('factionList');
                factionList.querySelectorAll('.faction-item').forEach(item => {
                    item.classList.toggle('highlighted', item.dataset.factionId === factionId);
                });
            }
        };

        window.clearFactionHighlights = () => {
            if (territoryAnimationSystem) {
                const factions = territoryAnimationSystem.getFactionList();
                factions.forEach(faction => {
                    territoryAnimationSystem.highlightFaction(faction.id, false);
                });
                // Update UI
                const factionList = document.getElementById('factionList');
                factionList.querySelectorAll('.faction-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
            }
        };

        window.showTerritoryStats = () => {
            if (territoryAnimationSystem) {
                const stats = territoryAnimationSystem.getTerritorialStats();
                console.log('Territory Statistics:', stats);
                alert(`Territory Statistics:
Total Territories: ${stats.totalTerritories}
Active Conflicts: ${stats.activeConflicts}
Active Trade Routes: ${stats.activeTradeRoutes}
Current Cycle: ${stats.currentCycle}
Animation Running: ${stats.isAnimating}`);
            }
        };

        window.getFactionList = () => {
            if (territoryAnimationSystem) {
                const factions = territoryAnimationSystem.getFactionList();
                console.log('Available Factions:', factions);
                return factions;
            }
        };

        window.jumpToTerritoryPeak = () => {
            if (temporalExtension) {
                temporalExtension.jumpToTime(-10, 1); // Imperial peak period
            }
        };

        window.jumpToConflictEra = () => {
            if (temporalExtension) {
                temporalExtension.jumpToTime(-10, 1); // Active conflict period
            }
        };

        // Historical snapshot debug functions
        window.toggleSnapshots = () => {
            if (historicalSnapshotSystem) {
                const checkbox = document.getElementById('snapshotsEnabled');
                checkbox.checked = !checkbox.checked;
                historicalSnapshotSystem.setSnapshotsEnabled(checkbox.checked);
            }
        };

        window.captureSnapshotNow = (title = 'Debug Snapshot') => {
            if (historicalSnapshotSystem) {
                historicalSnapshotSystem.captureCurrentState(title, 'Debug snapshot captured from console', 'user_bookmark')
                    .then(snapshot => {
                        console.log('Snapshot captured:', snapshot);
                        updateSnapshotList();
                        updateSnapshotStats();
                    })
                    .catch(error => console.error('Error capturing snapshot:', error));
            }
        };

        window.restoreLastSnapshot = () => {
            if (historicalSnapshotSystem) {
                const snapshots = historicalSnapshotSystem.getSnapshotList();
                if (snapshots.length > 0) {
                    const lastSnapshot = snapshots[snapshots.length - 1];
                    historicalSnapshotSystem.restoreSnapshot(lastSnapshot.id)
                        .then(() => console.log('Last snapshot restored'))
                        .catch(error => console.error('Error restoring snapshot:', error));
                } else {
                    console.log('No snapshots available');
                }
            }
        };

        window.showSnapshotStats = () => {
            if (historicalSnapshotSystem) {
                const stats = historicalSnapshotSystem.getSnapshotStats();
                console.log('Snapshot Statistics:', stats);
                alert(`Snapshot Statistics:
Total Snapshots: ${stats.totalSnapshots}
Auto-captured: ${stats.autoSnapshots}
User Bookmarks: ${stats.userSnapshots}
Storage Used: ${(stats.storageUsed / 1024).toFixed(1)} KB
Max Snapshots: ${stats.maxSnapshots}`);
            }
        };

        window.clearAllSnapshots = () => {
            if (historicalSnapshotSystem) {
                if (confirm('Clear all snapshots? This cannot be undone.')) {
                    historicalSnapshotSystem.clearAllSnapshots();
                    updateSnapshotList();
                    updateSnapshotStats();
                    console.log('All snapshots cleared');
                }
            }
        };

        window.exportSnapshotsNow = () => {
            if (historicalSnapshotSystem) {
                try {
                    historicalSnapshotSystem.exportSnapshots();
                    console.log('Snapshots exported');
                } catch (error) {
                    console.error('Error exporting snapshots:', error);
                }
            }
        };

        window.setAutoSnapshot = (enabled) => {
            if (historicalSnapshotSystem) {
                const checkbox = document.getElementById('autoSnapshotEnabled');
                checkbox.checked = enabled;
                historicalSnapshotSystem.setAutoSnapshot(enabled);
                console.log(`Auto-snapshot ${enabled ? 'enabled' : 'disabled'}`);
            }
        };

        window.getSnapshotList = () => {
            if (historicalSnapshotSystem) {
                const snapshots = historicalSnapshotSystem.getSnapshotList();
                console.log('Available Snapshots:', snapshots);
                return snapshots;
            }
        };

        // Temporal data export debug functions
        window.exportAllDataNow = (format = 'json') => {
            if (temporalDataExportSystem) {
                temporalDataExportSystem.exportAllData(format)
                    .then(result => console.log('Export completed:', result))
                    .catch(error => console.error('Export failed:', error));
            }
        };

        window.exportEventsData = (format = 'json') => {
            if (temporalDataExportSystem) {
                temporalDataExportSystem.exportCategory('events', format)
                    .then(result => console.log('Events export completed:', result))
                    .catch(error => console.error('Events export failed:', error));
            }
        };

        window.exportCharactersData = (format = 'json') => {
            if (temporalDataExportSystem) {
                temporalDataExportSystem.exportCategory('characters', format)
                    .then(result => console.log('Characters export completed:', result))
                    .catch(error => console.error('Characters export failed:', error));
            }
        };

        window.exportTerritoriesData = (format = 'json') => {
            if (temporalDataExportSystem) {
                temporalDataExportSystem.exportCategory('territories', format)
                    .then(result => console.log('Territories export completed:', result))
                    .catch(error => console.error('Territories export failed:', error));
            }
        };

        window.showExportStats = () => {
            if (temporalDataExportSystem) {
                const stats = temporalDataExportSystem.getExportStats();
                console.log('Export System Statistics:', stats);
                alert(`Export System Statistics:
Formats Supported: ${stats.formatsSupported}
Categories Supported: ${stats.categoriesSupported}
Systems Registered: ${stats.systemsRegistered}
Max File Size: ${Math.round(stats.maxFileSize / (1024 * 1024))} MB
Currently Exporting: ${stats.isExporting}
Progress: ${stats.progress}%`);
            }
        };

        window.getExportFormats = () => {
            if (temporalDataExportSystem) {
                const formats = temporalDataExportSystem.getExportFormats();
                console.log('Available Export Formats:', formats);
                return formats;
            }
        };

        window.getExportCategories = () => {
            if (temporalDataExportSystem) {
                const categories = temporalDataExportSystem.getDataCategories();
                console.log('Available Data Categories:', categories);
                return categories;
            }
        };

        window.testExportSystem = () => {
            if (temporalDataExportSystem) {
                console.log('Testing export system...');
                console.log('Formats:', temporalDataExportSystem.getExportFormats());
                console.log('Categories:', temporalDataExportSystem.getDataCategories());
                console.log('Stats:', temporalDataExportSystem.getExportStats());
                console.log('Export system test completed');
            }
        };

        console.log('4D Temporal Map script loaded');
        console.log('Debug functions available:');
        console.log('  Time: jumpToAncientPast(), jumpToFoundations(), jumpToPresent(), jumpToFuture(), playAnimation(), pauseAnimation()');
        console.log('  Events: createEventHere(), createEventAtLocation(lat, lon), showEventModal()');
        console.log('  Epochs: toggleEpochOverlays(), setEpochIntensity(0-1), showEpochInfo()');
        console.log('  Heat Maps: toggleHeatMap(), setHeatMapMode("density"|"importance"|"activity"|"participants"), setHeatMapIntensity(0-1), setHeatMapGridSize(10-100), refreshHeatMap(), showHeatMapStats()');
        console.log('  Journeys: toggleJourneys(), selectCharacter("char_1"), playCharacterJourney("char_1"), setJourneyOpacity(0-1), setJourneyTimeWindow(10-500), showJourneyStats(), getCharacterList(), selectAllCharacters(), deselectAllCharacters(), toggleRelationships(), toggleInfluenceZones()');
        console.log('  Territories: toggleTerritories(), toggleBorders(), toggleConflictZones(), toggleTradeRoutes(), setTerritoryOpacity(0-1), setBorderWidth(1-5), setTerritoryAnimationSpeed(0.1-3), highlightFaction("northern_kingdom"), clearFactionHighlights(), showTerritoryStats(), getFactionList(), jumpToTerritoryPeak(), jumpToConflictEra()');
        console.log('  Snapshots: toggleSnapshots(), captureSnapshotNow("title"), restoreLastSnapshot(), showSnapshotStats(), clearAllSnapshots(), exportSnapshotsNow(), setAutoSnapshot(true/false), getSnapshotList()');
        console.log('  Export: exportAllDataNow("format"), exportEventsData("format"), exportCharactersData("format"), exportTerritoriesData("format"), showExportStats(), getExportFormats(), getExportCategories(), testExportSystem()');
        console.log('Keyboard shortcuts: Space (play/pause), Arrow keys (step), Home/R (reset to present)');
        console.log('Visual Controls: Use the Era Visualizations, Heat Map, Character Journey, Territory Evolution, Historical Snapshot, and Data Export panels to customize visualizations!');
        console.log('Right-click on map to create events at specific locations!');
    </script>
</body>
</html>